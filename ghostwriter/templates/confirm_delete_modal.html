<!--Delete button will redirect to the href of the element with ``id = caller-id`` property in this modal-->
<div class="modal fade" id="confirm-delete-modal" tabindex="-1" caller-id="" role="dialog" aria-labelledby="confirm-delete-modal-label" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body confirm-delete">
        Are you sure you want to delete this <span id="object-type"></span>? This action is permanent!
        <div id="object-preview-content"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" data-dismiss="modal" id="confirm-delete-button-modal">Delete</button>
      </div>
    </div>
  </div>
</div>

{% comment %}
    Script to make modal appear whenever a user clicks any delete button/link

    The modal's Delete button fires the second script to actually delete the target entry
{% endcomment %}

<script>
    $('[data-target="#confirm-delete-modal"]').each(function(index) {
        $(this).click(function () {
            $('#confirm-delete-modal').attr('caller-id', $(this).attr('id'));
        });
    });
</script>

<script>
    $('#confirm-delete-modal').on('show.bs.modal', function(){
        var caller = $('#confirm-delete-button-modal').closest('.modal').attr('caller-id');
        var target = $('#' + caller);
        var targetId = target.attr('delete-target-id');
        var targetRow = target.closest('tr');
        var targetType = target.attr('delete-target-type');
        var previewContent = $('#delete-target-content-' + targetType + '-' + targetId);

        if (targetType) {
            $('#object-type').html(targetType);
        }

        if (previewContent) {
            $('#object-preview-content').html(previewContent.text());
        }
    });
</script>

{% comment %} Following a delete, fetch the latest information to update the badges on the tabs {% endcomment %}

<script>
    function update_badges() {
        console.log("Updating badges...");
        // Get the update URL from the ``nav-tabs`` element
        var navTabs = $('.nav-tabs');
        var update_url = navTabs.attr('js-update-tabs-url');
        // Save the ``id`` of thecurrent tab with the ``active`` class
        var activeTabId = $('ul#tab-bar a.active').attr('id');
        activeTabId = '#' + activeTabId;
        // Refresh the HTML from the update URL
        navTabs.html('').load(update_url, function() {
            // Set the previously active tab back to ``active``
            var targetTab = $(activeTabId);
            targetTab.tab('show');
        });
    }
</script>

{% comment %}
    Generic AJAX script that works with any of the AJAX views for deleting a model entry and any
    properly crafted delete link or button

    The delete link must have several attributes:

        * A unique ``id`` value
        * data-toggle="modal"
        * data-target="#confirm-delete-modal"
        * delete-target-csrftoken="{{ csrf_token }}"
        * delete-target-url="<POST URL, e.g., {% url 'rolodex:ajax_delete_project_assignment' operator.id %}>"
        * delete-target-id="<Object's ID, e.g. {{ operator.id }}>"
        * delete-target-type="<String Representing the Object to be Deleted>"

    The URL directs the POST to the proper URL without requiring multiple scripts for pages
    with more than one type of delete link

    The ``delete-target-type`` attribute is displayed in the delete modal and used as part of of the jQuery
    selector used for finding the preview content – this helps in case two objects from different models
    that share an ID number do not get confused when searching for ``object-preview-content-<ID>``

    Any ``<a>`` tags should also have ``href="javascript:void(0);"`` to avoid style issues
    brought on by an apparent bug in Bootstrap v4

    If desired, a preview of the content to be deleted can be displayed in the modal's
    ``object-preview-content`` section

    Flag the content that should be displayed with ``id="delete-target-content-<delete-target-type value>-{{ object.id }}"``

    The script gets the parent ``<tr>`` and then searches for a an element with a
    ``data-target-content-id`` attribute that matches the ``delete-target-id``

    If an element is found, the HTML will be included in the modal confirmation so the user knows they
    selected the correct object

    Example:
        <td nowrap id="delete-target-content-objective-{{ objective.id }}">{{ objective.objective }}</td>
{% endcomment %}

<script>
    $('#confirm-delete-button-modal').click(function () {
        // Get the ``id`` of the clicked element
        var caller = $('#confirm-delete-button-modal').closest('.modal').attr('caller-id');
        var target = $('#' + caller);
        // Values for the POST
        var url = target.attr('delete-target-url');
        var targetId = target.attr('delete-target-id');
        var targetType = target.attr('delete-target-type');
        var csrftoken = target.attr('delete-target-csrftoken');
        // Selectors for each major parent object – tr, tbody, and table
        var targetRow = target.closest('tr');
        var targetTbody = target.closest('tbody');
        var targetTable = target.closest('table');
        var targetContainer = $('#note-container-' + targetId);
        // Prep AJAX request with CSRF token
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader('X-CSRFToken', csrftoken);
                }
            }
        });
        // Send AJAX POST request
        $.ajax({
            url: url,
            type: 'POST',
            dataType: 'json',
            data: {
                'target': targetId,
                'target_type': targetType
            },
            success: function (data) {
                // If the delete succeeded, remove the row
                if (data['result'] == 'success') {
                    if (targetRow) {
                        targetRow.remove();
                    }
                    if (targetContainer) {
                        targetContainer.remove();
                    }
                    // If that was the last row, hide the empty table
                    if (targetTbody.find('tr').length == 0) {
                        targetTable.hide();
                    }
                    update_badges();
                }
                if (data['message']) {
                    displayToastTop({type:data['result'], string:data['message'], title:'Deleted'});
                }
            }
        });
    });
</script>